// BuildOS - Prisma Schema v1
// Strictly following ADR Pack V1

generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/client"
  binaryTargets = ["native", "linux-arm64-openssl-3.0.x", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// MULTI-TENANCY & AUTH
// ============================================================================

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users             User[]
  projects          Project[]
  materialCatalogs  MaterialCatalog[]
  workTypes         WorkType[]
  auditLogs         AuditLog[]
  roles             Role[]
  permissions       Permission[]

  @@map("tenants")
}

model User {
  id            String    @id @default(cuid())
  tenantId      String
  email         String
  name          String?
  passwordHash  String?
  emailVerified DateTime?
  image         String?
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  tenant         Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  roles          UserRole[]
  auditLogsAsActor AuditLog[]   @relation("AuditLogActor")

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
  @@map("users")
}

// ============================================================================
// RBAC (Role-Based Access Control)
// ============================================================================

model Role {
  id          String   @id @default(cuid())
  tenantId    String
  name        String   // e.g., "owner", "project_manager", "client"
  description String?
  isSystem    Boolean  @default(false) // System roles can't be deleted
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users       UserRole[]
  permissions RolePermission[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("roles")
}

model Permission {
  id          String   @id @default(cuid())
  tenantId    String   // All permissions are tenant-specific
  resource    String   // e.g., "estimates", "projects"
  action      String   // e.g., "view", "create", "view_cost"
  description String?
  isGlobal    Boolean  @default(false) // If true, applies to all tenants (seeded)
  createdAt   DateTime @default(now())

  // Relations
  tenant Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  roles  RolePermission[]

  @@unique([tenantId, resource, action])
  @@index([tenantId])
  @@index([resource, action])
  @@map("permissions")
}

model UserRole {
  id        String   @id @default(cuid())
  userId    String
  roleId    String
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

model RolePermission {
  id           String   @id @default(cuid())
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

// ============================================================================
// BUSINESS ENTITIES (with soft delete per ADR-03)
// ============================================================================

model Project {
  id          String    @id @default(cuid())
  tenantId    String
  name        String
  address     String?
  clientName  String?
  clientEmail String?
  clientPhone String?
  status      String    @default("draft") // draft, active, completed, archived
  notes       String?   @db.Text
  tags        String[]  @default([])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime? // Soft delete (ADR-03)

  // Relations
  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  rooms     Room[]
  estimates Estimate[]
  photos    Photo[]

  @@index([tenantId])
  @@index([tenantId, deletedAt]) // For filtering out deleted
  @@index([status])
  @@map("projects")
}

model Room {
  id        String    @id @default(cuid())
  tenantId  String
  projectId String
  name      String
  type      String? // bedroom, bathroom, kitchen, etc.
  length    Decimal?  @db.Decimal(10, 3) // meters
  width     Decimal?  @db.Decimal(10, 3)
  height    Decimal?  @db.Decimal(10, 3)
  area      Decimal?  @db.Decimal(10, 3) // calculated: length * width
  perimeter Decimal?  @db.Decimal(10, 3) // calculated: 2 * (length + width)
  wallArea  Decimal?  @db.Decimal(10, 3) // calculated: perimeter * height
  tileHeightMode String?  @default("full") // full | partial
  tileHeightValue Decimal? @db.Decimal(10, 3)
  tileWallsSelector String? @default("all") // all | selected (v1 uses all)
  notes     String?   @db.Text
  tags      String[]  @default([])
  order     Int       @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete (ADR-03)

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  stages  Stage[]

  @@index([tenantId])
  @@index([projectId])
  @@index([tenantId, deletedAt])
  @@map("rooms")
}

model Stage {
  id          String    @id @default(cuid())
  tenantId    String
  roomId      String
  name        String    // e.g., "Demolition", "Plumbing", "Painting"
  description String?   @db.Text
  status      String    @default("pending") // pending, in_progress, completed
  order       Int       @default(0)
  startedAt   DateTime?
  completedAt DateTime?
  notes       String?   @db.Text
  tags        String[]  @default([])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime? // Soft delete (ADR-03)

  // Relations
  room Room @relation(fields: [roomId], references: [id], onDelete: Cascade)
  photos Photo[]

  @@index([tenantId])
  @@index([roomId])
  @@index([tenantId, deletedAt])
  @@index([status])
  @@map("stages")
}

model Photo {
  id           String   @id @default(cuid())
  tenantId     String
  projectId    String
  stageId      String?
  filename     String
  url          String
  thumbnailUrl String?
  description  String?  @db.Text
  capturedAt   DateTime @default(now())
  uploadedBy   String?
  fileSize     Int?
  mimeType     String?
  width        Int?
  height       Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  deletedAt    DateTime?

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  stage   Stage?  @relation(fields: [stageId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([projectId])
  @@index([stageId])
  @@index([tenantId, deletedAt])
  @@map("photos")
}

// ============================================================================
// ESTIMATE ENGINE (Core Product - ADR-09: Margin Materialized)
// ============================================================================

model Estimate {
  id          String    @id @default(cuid())
  tenantId    String
  projectId   String
  version     Int       @default(1) // Versioning (ADR-09)
  status      String    @default("draft") // draft, sent, approved, rejected
  validUntil  DateTime?
  sentAt      DateTime?
  approvedAt  DateTime?

  // Totals (Materialized per ADR-09)
  totalCost     Decimal @db.Decimal(12, 2) // Sum of all costs
  totalClient   Decimal @db.Decimal(12, 2) // Sum of all client prices
  margin        Decimal @db.Decimal(12, 2) // totalClient - totalCost (MATERIALIZED!)
  marginPercent Decimal @db.Decimal(5, 2) // (margin / totalCost) * 100

  // PDF Generation (Issue #15)
  pdfUrl         String?
  pdfGeneratedAt DateTime?

  notes     String?   @db.Text
  tags      String[]  @default([])
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete (ADR-03)

  // Relations
  project Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  items   EstimateItem[]

  @@unique([projectId, version]) // Versioning constraint
  @@index([tenantId])
  @@index([projectId])
  @@index([tenantId, deletedAt])
  @@index([status])
  @@map("estimates")
}

model EstimateItem {
  id         String  @id @default(cuid())
  tenantId   String
  estimateId String
  type       String // "work", "material", "subcontractor"
  name       String
  description String? @db.Text
  unit       String // e.g., "m2", "pcs", "hours"
  quantity   Decimal @db.Decimal(10, 3)

  // Cost breakdown (internal)
  unitCost  Decimal @db.Decimal(12, 2) // Cost per unit
  totalCost Decimal @db.Decimal(12, 2) // quantity * unitCost

  // Client pricing
  unitClient  Decimal @db.Decimal(12, 2) // Client price per unit
  totalClient Decimal @db.Decimal(12, 2) // quantity * unitClient

  // Margin (Materialized per ADR-09)
  margin        Decimal @db.Decimal(12, 2) // totalClient - totalCost
  marginPercent Decimal @db.Decimal(5, 2) // (margin / totalCost) * 100

  // Optional catalog references
  materialCatalogId String?
  workTypeId        String?

  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  estimate        Estimate         @relation(fields: [estimateId], references: [id], onDelete: Cascade)
  materialCatalog MaterialCatalog? @relation(fields: [materialCatalogId], references: [id])
  workType        WorkType?        @relation(fields: [workTypeId], references: [id])

  @@index([tenantId])
  @@index([estimateId])
  @@index([type])
  @@index([materialCatalogId])
  @@index([workTypeId])
  @@map("estimate_items")
}

// ============================================================================
// CATALOGS (i18n with Translation Tables per ADR-08)
// ============================================================================

model MaterialCatalog {
  id        String   @id @default(cuid())
  tenantId  String
  sku       String? // Optional SKU/code
  category  String?
  unit      String // e.g., "m2", "pcs", "kg"
  unitCost  Decimal  @db.Decimal(12, 2)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant       Tenant                      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  translations MaterialCatalogTranslation[] // i18n (ADR-08)
  estimateItems EstimateItem[]

  @@unique([tenantId, sku])
  @@index([tenantId])
  @@index([category])
  @@map("material_catalogs")
}

model MaterialCatalogTranslation {
  id                String   @id @default(cuid())
  materialCatalogId String
  locale            String // "en", "ru", "pl"
  name              String // Searchable!
  description       String?  @db.Text
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  materialCatalog MaterialCatalog @relation(fields: [materialCatalogId], references: [id], onDelete: Cascade)

  @@unique([materialCatalogId, locale])
  @@index([materialCatalogId])
  @@index([locale])
  @@index([name]) // For search
  @@map("material_catalog_translations")
}

model WorkType {
  id        String   @id @default(cuid())
  tenantId  String
  code      String?
  category  String?
  unit      String // e.g., "m2", "hours"
  unitCost  Decimal  @db.Decimal(12, 2)
  clientUnitPrice      Decimal @db.Decimal(12, 2)
  laborNormHoursPerUnit Decimal @db.Decimal(10, 3) @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant        Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  translations  WorkTypeTranslation[] // i18n (ADR-08)
  estimateItems EstimateItem[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([category])
  @@map("work_types")
}

model WorkTypeTranslation {
  id          String   @id @default(cuid())
  workTypeId  String
  locale      String // "en", "ru", "pl"
  name        String // Searchable!
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  workType WorkType @relation(fields: [workTypeId], references: [id], onDelete: Cascade)

  @@unique([workTypeId, locale])
  @@index([workTypeId])
  @@index([locale])
  @@index([name]) // For search
  @@map("work_type_translations")
}

// ============================================================================
// INVOICES (Future - placeholder for MVP)
// ============================================================================

model Invoice {
  id          String    @id @default(cuid())
  tenantId    String
  projectId   String?
  number      String // Invoice number
  status      String    @default("draft") // draft, sent, paid, cancelled
  issueDate   DateTime
  dueDate     DateTime?
  amount      Decimal   @db.Decimal(12, 2)
  currency    String    @default("PLN")
  notes       String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime? // Soft delete (ADR-03)

  @@unique([tenantId, number])
  @@index([tenantId])
  @@index([tenantId, deletedAt])
  @@index([status])
  @@map("invoices")
}

// ============================================================================
// AUDIT LOG (ADR-04: Comprehensive Audit Trail)
// ============================================================================

model AuditLog {
  id         String   @id @default(cuid())
  tenantId   String
  traceId    String // For correlating related actions (ADR-04)
  actorType  String // "user", "system", "api" (ADR-04)
  actorId    String? // User ID if actorType = "user"
  action     String // "create", "update", "delete", "view"
  resource   String // "project", "estimate", "user"
  resourceId String?
  changes    Json? // Before/after snapshot
  metadata   Json? // Additional context
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  actor  User?  @relation("AuditLogActor", fields: [actorId], references: [id])

  @@index([tenantId])
  @@index([traceId])
  @@index([actorType, actorId])
  @@index([resource, resourceId])
  @@index([createdAt])
  @@map("audit_logs")
}
